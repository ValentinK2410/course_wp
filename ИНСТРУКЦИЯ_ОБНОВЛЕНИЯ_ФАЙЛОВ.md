# Инструкция по обновлению файлов на сервере

## Проблема
Директория плагина на сервере не является git репозиторием, поэтому нельзя использовать `git pull`.

## Решение

### Вариант 1: Использование скрипта (рекомендуется)

**На вашем локальном компьютере:**

1. Перейдите в директорию проекта:
   ```bash
   cd /Users/valentink2410/.cursor/worktrees/course_wp/nuq
   ```

2. Сделайте скрипт исполняемым:
   ```bash
   chmod +x update-all-files.sh
   ```

3. Запустите скрипт:
   ```bash
   ./update-all-files.sh
   ```

Скрипт автоматически скопирует все важные файлы на сервер.

---

### Вариант 2: Ручное копирование через SCP

**С вашего локального компьютера:**

```bash
cd /Users/valentink2410/.cursor/worktrees/course_wp/nuq

# Копирование файлов защиты от ботов
scp course-plugin/includes/class-course-anti-bot.php \
    root@site.dekan.pro:/var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes/

scp course-plugin/includes/class-course-anti-bot-admin.php \
    root@site.dekan.pro:/var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes/

# Копирование файла синхронизации пользователей (исправление критической ошибки)
scp course-plugin/includes/class-course-moodle-user-sync.php \
    root@site.dekan.pro:/var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes/

# Копирование файла регистрации (форма повторной отправки письма)
scp course-plugin/includes/class-course-registration.php \
    root@site.dekan.pro:/var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes/
```

---

### Вариант 3: Прямое редактирование на сервере

**На сервере через SSH:**

1. **Исправление критической ошибки входа:**
   ```bash
   cd /var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes
   nano class-course-moodle-user-sync.php
   ```
   
   Найдите строки 86-88 и удалите их:
   ```php
   // Регистрируем хук для синхронизации пароля при первом входе пользователя
   // Это позволяет синхронизировать временный пароль обратно в Moodle
   add_action('wp_login', array($this, 'sync_password_on_first_login'), 10, 2);
   ```

2. **Обновление настроек лимита регистрации:**
   ```bash
   nano class-course-anti-bot.php
   ```
   
   Найдите строку:
   ```php
   $max_attempts = get_option('rate_limit_attempts', 5);
   ```
   
   Измените на:
   ```php
   $max_attempts = get_option('rate_limit_attempts', 10);
   ```
   
   Найдите строку:
   ```php
   $period = get_option('rate_limit_period', 3600);
   ```
   
   Измените на:
   ```php
   $period = get_option('rate_limit_period', 1800);
   ```

---

### Вариант 4: Использование sed для автоматического исправления

**На сервере выполните:**

```bash
cd /var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes

# Создайте резервные копии
cp class-course-moodle-user-sync.php class-course-moodle-user-sync.php.backup
cp class-course-anti-bot.php class-course-anti-bot.php.backup

# Удалите проблемную строку с хуком
sed -i '/sync_password_on_first_login/,+2d' class-course-moodle-user-sync.php

# Обновите настройки по умолчанию для лимита
sed -i "s/get_option('rate_limit_attempts', 5)/get_option('rate_limit_attempts', 10)/g" class-course-anti-bot.php
sed -i "s/get_option('rate_limit_period', 3600)/get_option('rate_limit_period', 1800)/g" class-course-anti-bot.php

# Проверьте синтаксис
php -l class-course-moodle-user-sync.php
php -l class-course-anti-bot.php
```

---

## Проверка после обновления

1. **Проверьте синтаксис PHP:**
   ```bash
   php -l /var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes/class-course-moodle-user-sync.php
   php -l /var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes/class-course-anti-bot.php
   ```

2. **Проверьте сайт:**
   - Откройте: `https://site.dekan.pro/wp-login.php`
   - Страница должна загружаться без ошибок
   - Попробуйте зарегистрироваться

3. **Очистите кеш WordPress** (если используется плагин кеширования)

---

## Быстрое решение (одна команда на сервере)

```bash
cd /var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes && \
cp class-course-moodle-user-sync.php class-course-moodle-user-sync.php.backup && \
sed -i '/sync_password_on_first_login/,+2d' class-course-moodle-user-sync.php && \
sed -i "s/get_option('rate_limit_attempts', 5)/get_option('rate_limit_attempts', 10)/g" class-course-anti-bot.php && \
sed -i "s/get_option('rate_limit_period', 3600)/get_option('rate_limit_period', 1800)/g" class-course-anti-bot.php && \
php -l class-course-moodle-user-sync.php && \
php -l class-course-anti-bot.php
```

Эта команда:
1. Переходит в нужную директорию
2. Создает резервную копию
3. Удаляет проблемную строку
4. Обновляет настройки лимита
5. Проверяет синтаксис PHP

---

## Если что-то пошло не так

**Восстановите из резервной копии:**

```bash
cd /var/www/www-root/data/www/site.dekan.pro/wp-content/plugins/course-plugin/includes
cp class-course-moodle-user-sync.php.backup class-course-moodle-user-sync.php
cp class-course-anti-bot.php.backup class-course-anti-bot.php
```

---

**Готово!** После обновления файлов сайт должен работать корректно.

