# Как синхронизировать курсы из Moodle в Laravel через WordPress

## Процесс синхронизации

Синхронизация курсов происходит автоматически в следующем порядке:

1. **Moodle** → **WordPress** → **Laravel**
2. При синхронизации курсов из Moodle в WordPress, каждый курс автоматически отправляется в Laravel приложение

## Шаг 1: Настройка Laravel приложения

### 1.1. Выполнить миграцию базы данных

На сервере с Laravel приложением выполните:

```bash
cd /path/to/education-management-system
php artisan migrate
```

Это добавит необходимые поля в таблицу `courses`:
- `wordpress_course_id`
- `moodle_course_id`
- `short_description`
- `category_id`, `category_name`
- `start_date`, `end_date`
- `capacity`, `enrolled`
- `meta` (JSON поле)

### 1.2. Настроить API токен

В файле `.env` Laravel приложения убедитесь, что установлен токен:

```env
WORDPRESS_API_TOKEN=your-secret-token-here
```

Этот токен должен совпадать с токеном в настройках WordPress плагина.

## Шаг 2: Настройка WordPress плагина

### 2.1. Настроить Laravel API

В админ-панели WordPress перейдите в:
**Настройки → Настройки синхронизации Moodle**

Заполните поля:
- **Laravel API URL**: `https://m.dekan.pro`
- **Laravel API Token**: должен совпадать с `WORDPRESS_API_TOKEN` в Laravel

### 2.2. Настроить Moodle API

Убедитесь, что настроены:
- **Moodle URL**: `https://class.dekan.pro`
- **Moodle Token**: токен для доступа к Moodle REST API
- **Включить синхронизацию**: включено

## Шаг 3: Запуск синхронизации

### 3.1. Через админ-панель WordPress

1. Перейдите в **Настройки → Настройки синхронизации Moodle**
2. Прокрутите страницу вниз до раздела "Синхронизация данных"
3. Нажмите кнопку **"Синхронизировать сейчас"**

### 3.2. Автоматическая синхронизация

Синхронизация также происходит автоматически каждый час через WordPress Cron.

## Шаг 4: Проверка синхронизации

### 4.1. Проверка в WordPress

1. Перейдите в **Курсы Про → Все курсы**
2. Убедитесь, что курсы из Moodle появились в WordPress
3. Откройте любой курс и проверьте метаполе `moodle_course_id`

### 4.2. Проверка в Laravel

1. Войдите в админ-панель Laravel приложения
2. Перейдите в раздел курсов
3. Проверьте, что курсы появились с заполненными полями:
   - `wordpress_course_id`
   - `moodle_course_id`
   - `name`, `description`
   - И другие поля

### 4.3. Проверка логов

**WordPress логи:**
- `wp-content/debug.log` (если включен `WP_DEBUG`)
- `wp-content/uploads/course-plugin-logs/sync-YYYY-MM-DD.log`

Ищите сообщения:
- `Moodle Sync: Курс успешно синхронизирован с Laravel приложением`
- `Moodle Sync: Ошибка синхронизации курса с Laravel`

**Laravel логи:**
- `storage/logs/laravel.log`

Ищите сообщения:
- `Course successfully created from WordPress`
- `Course successfully updated from WordPress`

## Что синхронизируется

При синхронизации курса из Moodle в WordPress, а затем в Laravel передаются следующие данные:

- **wordpress_course_id** - ID курса в WordPress
- **moodle_course_id** - ID курса в Moodle
- **name** - Название курса
- **description** - Полное описание курса
- **short_description** - Краткое описание
- **category_id** - ID категории из Moodle
- **category_name** - Название категории
- **start_date** - Дата начала курса
- **end_date** - Дата окончания курса
- **duration** - Продолжительность курса (в часах)
- **price** - Стоимость курса
- **capacity** - Вместимость курса (количество мест)
- **enrolled** - Количество записанных студентов
- **status** - Статус курса (publish/draft/pending/private)

## Устранение проблем

### Проблема: Курсы не синхронизируются в Laravel

**Решение:**
1. Проверьте, что в WordPress настроены Laravel API URL и Token
2. Проверьте, что в Laravel `.env` установлен `WORDPRESS_API_TOKEN`
3. Проверьте, что токены совпадают
4. Проверьте логи WordPress и Laravel на наличие ошибок
5. Убедитесь, что маршрут `/api/courses/sync-from-wordpress` исключен из CSRF защиты

### Проблема: Ошибка 401 Unauthorized

**Решение:**
- Убедитесь, что токены в WordPress и Laravel совпадают
- Проверьте заголовок `X-API-Token` в запросе

### Проблема: Ошибка 422 Validation failed

**Решение:**
- Проверьте логи Laravel для деталей ошибки валидации
- Убедитесь, что все обязательные поля заполнены

### Проблема: Курсы создаются, но поля пустые

**Решение:**
- Проверьте, что миграция выполнена успешно
- Убедитесь, что поля добавлены в `$fillable` модели `Course`
- Проверьте, что данные передаются из WordPress (проверьте логи)

## Ручная синхронизация через WP-CLI (опционально)

Если нужно синхронизировать курсы через командную строку:

```bash
cd /path/to/wordpress
wp eval 'Course_Moodle_Sync::get_instance()->sync_data();'
```

## Дополнительная информация

- Документация по настройке: `LARAVEL_COURSE_SYNC_SETUP.md`
- API endpoint Laravel: `POST /api/courses/sync-from-wordpress`
- Требуемый заголовок: `X-API-Token: your-token-here`

