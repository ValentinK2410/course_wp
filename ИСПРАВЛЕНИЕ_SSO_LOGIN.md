# Исправление проблемы с SSO login.php в Moodle

## Проблема

После добавления файла `auth/sso/login.php` в Moodle, возникла проблема с просмотром пользователей в админ-панели Moodle.

## Причина

Проблема была в том, что файл `login.php` мог выполняться при различных запросах к Moodle, а не только при SSO аутентификации. Это происходило из-за:

1. **Отсутствие проверки наличия токена** - файл мог выполняться даже когда токен не передан
2. **Неправильный синтаксис `redirect()`** - использовался `redirect('/')` вместо `redirect(new moodle_url('/'))`
3. **Отсутствие обработки ошибок** - при ошибках скрипт мог ломать работу Moodle

## Решение

Исправленный файл `moodle-sso-login-fixed.php` содержит следующие улучшения:

### 1. Проверка наличия токена в начале файла

```php
if (!isset($_GET['token'])) {
    // Если токен не передан, просто завершаем выполнение без редиректа
    die();
}
```

Это предотвращает выполнение скрипта при просмотре пользователей и других операциях в Moodle.

### 2. Правильный синтаксис редиректов

```php
// НЕПРАВИЛЬНО (старый код):
redirect('/');
redirect('/login/index.php');

// ПРАВИЛЬНО (новый код):
redirect(new moodle_url('/'));
redirect(new moodle_url('/login/index.php'), 'Сообщение', null, \core\output\notification::NOTIFY_ERROR);
```

### 3. Обработка ошибок

Добавлена обработка всех возможных ошибок:
- Ошибки cURL при запросе к WordPress
- Неверный HTTP код ответа
- Неверный формат JSON ответа
- Ошибки базы данных при поиске пользователя
- Ошибки при входе пользователя

### 4. Логирование

Добавлено логирование всех операций и ошибок для отладки.

## Установка исправленного файла

1. **Скопируйте исправленный файл** `moodle-sso-login-fixed.php` в директорию Moodle:
   ```bash
   cp moodle-sso-login-fixed.php /path/to/moodle/auth/sso/login.php
   ```

2. **Установите правильные права доступа**:
   ```bash
   chmod 644 /path/to/moodle/auth/sso/login.php
   ```

3. **Проверьте, что файл находится в правильном месте**:
   - Путь должен быть: `/path/to/moodle/auth/sso/login.php`
   - НЕ должен быть в корне Moodle или в других местах

## Проверка работы

1. **Проверьте просмотр пользователей в Moodle**:
   - Войдите в админ-панель Moodle
   - Перейдите в "Пользователи" → "Список пользователей"
   - Должно работать без ошибок

2. **Проверьте SSO вход**:
   - Войдите в WordPress
   - Перейдите в Moodle через SSO ссылку
   - Должен произойти автоматический вход

## Дополнительные рекомендации

### Вариант 1: Использовать плагин аутентификации Moodle

Вместо отдельного файла `login.php`, лучше создать полноценный плагин аутентификации для Moodle. Это более безопасный и правильный подход.

### Вариант 2: Использовать .htaccess для защиты

Если файл находится в `auth/sso/login.php`, можно добавить `.htaccess` для дополнительной защиты:

```apache
<Files "login.php">
    Order Allow,Deny
    Allow from all
</Files>
```

### Вариант 3: Проверка через Moodle конфигурацию

Можно вынести настройки WordPress URL и SSO API ключ в конфигурацию Moodle:

```php
// В config.php или через админ-панель Moodle
$CFG->wordpress_url = 'https://site.dekan.pro';
$CFG->sso_api_key = 'ваш-ключ';
```

Затем в `login.php`:
```php
$wordpress_url = $CFG->wordpress_url;
$sso_api_key = $CFG->sso_api_key;
```

## Отладка

Если проблемы остаются:

1. **Проверьте логи Moodle**:
   - Обычно находятся в `/path/to/moodle/data/error.log`
   - Или в настройках PHP error_log

2. **Проверьте логи WordPress**:
   - `wp-content/debug.log`
   - Проверьте, что запросы от Moodle доходят до WordPress

3. **Проверьте права доступа**:
   - Файл должен быть доступен для чтения веб-сервером
   - Но не должен быть доступен для записи

4. **Проверьте путь к файлу**:
   - Убедитесь, что файл находится именно в `auth/sso/login.php`
   - Проверьте, что `require_once(__DIR__ . '/../../config.php')` правильно загружает конфигурацию Moodle

## Важные замечания

⚠️ **ВАЖНО**: После исправления файла обязательно проверьте:
- Просмотр пользователей в админ-панели Moodle работает
- SSO вход работает корректно
- Нет ошибок в логах Moodle

Если проблемы остаются, возможно, файл находится в неправильном месте или есть конфликт с другими плагинами Moodle.

