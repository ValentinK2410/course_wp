# Синхронизация пользователей из Moodle в WordPress и Laravel

## Описание

Этот скрипт позволяет синхронизировать существующих пользователей из Moodle в WordPress и Laravel, чтобы они могли использовать SSO (Single Sign-On) на всех трех платформах.

## Важно о паролях

**Проблема:** Пароли в Moodle хранятся в хэшированном виде, поэтому мы не можем получить оригинальный пароль пользователя.

**Решение:** Скрипт создает пользователей с временными паролями и отправляет им письма с инструкциями. После первого входа пользователи смогут сменить пароль, который автоматически синхронизируется во все системы.

## Установка

1. Скопируйте файл `sync-users-from-moodle.php` в **корневую директорию WordPress** (не в папку плагина!)
2. Убедитесь, что настроены:
   - Moodle API URL и Token (в настройках плагина WordPress)
   - Laravel API URL и Token (в настройках плагина WordPress)

## Использование

### Вариант 1: Через браузер (рекомендуется)

1. Откройте в браузере: `https://site.dekan.pro/sync-users-from-moodle.php`
2. Войдите как администратор WordPress
3. Скрипт автоматически:
   - Получит всех пользователей из Moodle
   - Проверит, какие из них уже есть в WordPress
   - Создаст недостающих пользователей в WordPress
   - Создаст их в Laravel
   - Отправит письма с временными паролями

### Вариант 2: Через командную строку

```bash
cd /path/to/wordpress
php sync-users-from-moodle.php
```

## Что делает скрипт

1. **Получает всех пользователей из Moodle** через REST API
2. **Для каждого пользователя:**
   - Проверяет, существует ли пользователь в WordPress (по email)
   - Если существует - обновляет `moodle_user_id` в метаданных
   - Если не существует:
     - Создает пользователя в WordPress с временным паролем
     - Сохраняет `moodle_user_id` в метаданных
     - Создает пользователя в Laravel через API
     - Отправляет письмо с временным паролем

## Письмо пользователю

Каждый новый пользователь получит письмо со следующей информацией:
- Логин (username из Moodle)
- Временный пароль
- Ссылки для входа на все три платформы
- Инструкция сменить пароль после первого входа

## Безопасность

⚠️ **ВАЖНО:** После использования **обязательно удалите** файл `sync-users-from-moodle.php` с сервера!

Этот скрипт имеет доступ к созданию пользователей и должен быть защищен.

## Роли пользователей

По умолчанию все синхронизированные пользователи получают роль `subscriber` в WordPress. Вы можете изменить это в коде скрипта:

```php
'role' => 'subscriber' // Измените на нужную роль
```

## Обработка ошибок

Скрипт логирует все действия и ошибки:
- Успешное создание пользователей
- Пропущенные пользователи (без email, дубликаты)
- Ошибки API Moodle и Laravel

## После синхронизации

После успешной синхронизации пользователи смогут:
1. Войти в WordPress с временным паролем
2. Войти в Moodle с их существующим паролем (пароль в Moodle не изменяется)
3. Войти в Laravel с временным паролем
4. Использовать SSO для перехода между платформами (после входа в WordPress)

## Рекомендации

1. **Перед запуском** сделайте резервную копию базы данных WordPress
2. **Запустите скрипт** в нерабочее время, чтобы не перегружать сервер
3. **Проверьте логи** после выполнения
4. **Удалите скрипт** с сервера после использования
5. **Уведомите пользователей** о том, что они получат письма с временными паролями

## Решение проблем

### Ошибка "Настройки Moodle API не заполнены"
- Перейдите в админ-панель WordPress
- Настройки → Синхронизация с Moodle
- Заполните Moodle URL и Token

### Ошибка "Laravel API не настроен"
- Перейдите в админ-панель WordPress
- Настройки → Синхронизация с Moodle
- Заполните Laravel API URL и Token

### Пользователи не получают письма
- Проверьте настройки почты WordPress
- Проверьте логи: `wp-content/course-registration-debug.log`
- Убедитесь, что email пользователей в Moodle корректный

### Дубликаты пользователей
- Скрипт автоматически пропускает пользователей, которые уже существуют в WordPress
- Если пользователь существует, но не имеет `moodle_user_id`, скрипт обновит метаданные

## Дополнительная информация

После синхронизации пользователи смогут использовать SSO для входа на все три платформы. SSO работает следующим образом:
1. Пользователь входит в WordPress
2. При переходе на Moodle или Laravel через SSO-ссылки, система автоматически авторизует пользователя
3. Пароли синхронизируются при изменении в WordPress

