# Полная инструкция по синхронизации пользователей из Moodle в WordPress и Laravel

## Цель

Синхронизировать существующих пользователей из Moodle в WordPress и Laravel, чтобы они могли:
1. Войти в WordPress со своим паролем из Moodle
2. Войти в Laravel с тем же паролем
3. Использовать SSO через WordPress для перехода между платформами

## Важно о паролях

**Проблема:** Пароли в Moodle хранятся в хэшированном виде, поэтому мы не можем получить оригинальный пароль пользователя.

**Решение:** 
1. Скрипт создает пользователей с временными паролями
2. Временный пароль **автоматически обновляется в Moodle** при синхронизации
3. Пользователи получают письмо с временным паролем
4. После первого входа в WordPress пароль синхронизируется во все системы при изменении

## Шаг 1: Подготовка

### 1.1. Убедитесь, что настроены API

В админ-панели WordPress:
- **Настройки** → **Moodle Sync**
- Заполните:
  - Moodle URL (например: `https://class.dekan.pro`)
  - Moodle Token (токен REST API из Moodle)
  - Laravel API URL (например: `https://m.dekan.pro`)
  - Laravel API Token (токен из Laravel)

### 1.2. Получите токен Moodle REST API

1. Войдите в Moodle как администратор
2. Перейдите: **Администрирование сайта** → **Сервер** → **Плагины** → **Веб-сервисы** → **Управление токенами**
3. Создайте новый токен для пользователя с правами администратора
4. Скопируйте токен и вставьте в настройки WordPress

## Шаг 2: Запуск синхронизации

### 2.1. Скопируйте скрипт в корень WordPress

```bash
cp course-plugin/sync-users-from-moodle.php /path/to/wordpress/sync-users-from-moodle.php
```

**ВАЖНО:** Файл должен быть в корне WordPress, рядом с `wp-config.php`!

### 2.2. Установите права доступа

```bash
chmod 644 /path/to/wordpress/sync-users-from-moodle.php
```

### 2.3. Запустите синхронизацию

**Вариант 1: Через браузер (рекомендуется)**

1. Откройте в браузере: `https://site.dekan.pro/sync-users-from-moodle.php`
2. Войдите как администратор WordPress
3. Скрипт автоматически:
   - Получит всех пользователей из Moodle
   - Создаст их в WordPress с временными паролями
   - Обновит пароли в Moodle на временные
   - Создаст их в Laravel
   - Отправит письма с временными паролями

**Вариант 2: Через командную строку**

```bash
cd /path/to/wordpress
php sync-users-from-moodle.php
```

## Шаг 3: Что происходит при синхронизации

Для каждого пользователя из Moodle:

1. **Проверка существования:**
   - Если пользователь уже есть в WordPress (по email) - обновляется `moodle_user_id`
   - Если пользователя нет - создается новый

2. **Создание в WordPress:**
   - Генерируется временный пароль (12 символов)
   - Создается пользователь с этим паролем
   - Сохраняется `moodle_user_id` в метаданных

3. **Обновление пароля в Moodle:**
   - Временный пароль отправляется в Moodle через API
   - Пароль пользователя в Moodle заменяется на временный
   - Теперь пользователь может войти в Moodle с временным паролем

4. **Создание в Laravel:**
   - Пользователь создается в Laravel через API
   - Используется тот же временный пароль

5. **Отправка письма:**
   - Пользователь получает письмо с:
     - Логином (username из Moodle)
     - Временным паролем
     - Ссылками для входа на все три платформы

## Шаг 4: Использование после синхронизации

### 4.1. Вход пользователей

Пользователи могут войти на любую из трех платформ с временным паролем:

- **WordPress:** `https://site.dekan.pro/wp-login.php`
- **Moodle:** `https://class.dekan.pro/login/index.php`
- **Laravel:** `https://m.dekan.pro/login`

### 4.2. Смена пароля

Когда пользователь меняет пароль в WordPress:
1. Пароль автоматически синхронизируется в Moodle
2. Пароль автоматически синхронизируется в Laravel
3. После этого пользователь может использовать один пароль для всех систем

### 4.3. Использование SSO

После входа в WordPress пользователи могут использовать SSO:

```javascript
// В консоли браузера или на странице WordPress
goToMoodle();    // Переход в Moodle с автоматическим входом
goToLaravel();   // Переход в Laravel с автоматическим входом
```

## Шаг 5: Проверка результатов

### 5.1. Проверка в WordPress

1. Войдите в админ-панель WordPress
2. Перейдите: **Пользователи** → **Все пользователи**
3. Проверьте, что пользователи из Moodle созданы
4. Откройте профиль пользователя и проверьте мета-поле `moodle_user_id`

### 5.2. Проверка в Moodle

1. Войдите в Moodle как администратор
2. Перейдите: **Администрирование сайта** → **Пользователи** → **Список пользователей**
3. Проверьте, что пароли пользователей обновлены (можно попробовать войти с временным паролем)

### 5.3. Проверка в Laravel

1. Войдите в админ-панель Laravel
2. Проверьте список пользователей
3. Убедитесь, что пользователи из Moodle созданы

## Шаг 6: После синхронизации

### 6.1. Удалите скрипт

**ВАЖНО:** После успешной синхронизации удалите файл `sync-users-from-moodle.php` с сервера!

```bash
rm /path/to/wordpress/sync-users-from-moodle.php
```

### 6.2. Уведомите пользователей

Отправьте пользователям уведомление о том, что:
- Они получили письма с временными паролями
- Они могут войти на все три платформы с временным паролем
- Рекомендуется сменить пароль после первого входа
- После смены пароля он будет работать на всех платформах

## Решение проблем

### Проблема: Пользователи не получают письма

**Решение:**
1. Проверьте настройки почты WordPress
2. Проверьте логи: `wp-content/debug.log`
3. Убедитесь, что email пользователей в Moodle корректный

### Проблема: Пароли не обновляются в Moodle

**Решение:**
1. Проверьте токен Moodle API
2. Проверьте права доступа токена (должен иметь права на обновление пользователей)
3. Проверьте логи WordPress

### Проблема: Пользователи не создаются в Laravel

**Решение:**
1. Проверьте настройки Laravel API в WordPress
2. Проверьте, что API endpoint `/api/users/sync-from-wordpress` существует в Laravel
3. Проверьте логи Laravel

### Проблема: Дубликаты пользователей

**Решение:**
- Скрипт автоматически пропускает пользователей, которые уже существуют в WordPress
- Если пользователь существует, но не имеет `moodle_user_id`, скрипт обновит метаданные

## Автоматическая синхронизация паролей

После синхронизации пользователей, пароли автоматически синхронизируются:

1. **При изменении пароля в WordPress:**
   - Пароль автоматически обновляется в Moodle
   - Пароль автоматически обновляется в Laravel

2. **При сбросе пароля в WordPress:**
   - Новый пароль автоматически синхронизируется во все системы

3. **При первом входе:**
   - Система помечает, что пароль нужно синхронизировать
   - При следующем изменении пароля он синхронизируется автоматически

## Безопасность

⚠️ **ВАЖНО:**
- После использования удалите скрипт `sync-users-from-moodle.php` с сервера
- Временные пароли отправляются по email - убедитесь, что почта настроена безопасно
- Рекомендуется использовать HTTPS для всех платформ
- Регулярно проверяйте логи на наличие ошибок

## Резюме процесса

1. ✅ Настройте API (Moodle и Laravel) в WordPress
2. ✅ Запустите скрипт синхронизации
3. ✅ Пользователи созданы в WordPress и Laravel
4. ✅ Пароли обновлены в Moodle на временные
5. ✅ Пользователи получили письма с временными паролями
6. ✅ Пользователи могут войти на все три платформы
7. ✅ При смене пароля он синхронизируется автоматически
8. ✅ SSO работает через WordPress

После выполнения всех шагов пользователи смогут использовать один пароль для всех трех платформ и SSO для перехода между ними!

