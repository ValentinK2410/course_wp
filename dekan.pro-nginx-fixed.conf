# HTTP сервер - редирект на HTTPS
server {
    listen 82.146.39.18:80 default_server;
    server_name dekan.pro www.dekan.pro;
    
    # Постоянный редирект на HTTPS (должен быть первым)
    return 301 https://$host$request_uri;
    
    # Логирование (выполнится только если return не сработает)
    access_log /var/www/httpd-logs/dekan.pro.access.log;
    error_log /var/www/httpd-logs/dekan.pro.error.log notice;
}

# HTTPS сервер
server {
    listen 82.146.39.18:443 ssl default_server;
    server_name dekan.pro www.dekan.pro;
    
    # SSL-сертификаты
    ssl_certificate "/var/www/httpd-cert/www-root/dekan.pro_le1.crtca";
    ssl_certificate_key "/var/www/httpd-cert/www-root/dekan.pro_le1.key";
    
    # Современные настройки SSL
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers EECDH:+AES256:-3DES:RSA+AES:!NULL:!RC4;
    ssl_prefer_server_ciphers on;
    ssl_dhparam /etc/ssl/certs/dhparam4096.pem;
    ssl_ecdh_curve secp384r1;
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # Безопасные заголовки
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Базовые настройки
    charset UTF-8;
    index index.html index.php;
    disable_symlinks if_not_owner from=$root_path;
    
    # Включаемые конфигурации
    include /etc/nginx/vhosts-includes/*.conf;
    include /etc/nginx/vhosts-resources/dekan.pro/*.conf;
    include /etc/nginx/users-resources/www-root/*.conf;
    
    # Логирование
    access_log /var/www/httpd-logs/dekan.pro.access.log;
    error_log /var/www/httpd-logs/dekan.pro.error.log notice;
    
    # SSI
    ssi on;
    
    # Корневая директория (WordPress)
    set $root_path /var/www/www-root/data/www/dekan.pro;
    root $root_path;
    
    # Настройки Gzip
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_disable "msie6";
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;
    gzip_vary on;
    gzip_proxied any;
    
    # Запрет доступа к скрытым файлам
    location ~ /\.(?!well-known).* {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Кэширование статических файлов
    location ~* \.(?:jpg|jpeg|gif|png|ico|svg|js|css|mp3|ogg|mpe?g|avi|zip|gz|bz2?|rar|swf|webp|woff|woff2)$ {
        expires 24h;
        access_log off;
        add_header Cache-Control "public";
        try_files $uri =404;
    }
    
    # Обработка PHP для WordPress
    location ~ [^/]\.ph(p\d*|tml)$ {
        try_files /does_not_exists @php;
    }
    
    location @php {
        include /etc/nginx/vhosts-resources/dekan.pro/dynamic/*.conf;
        fastcgi_index index.php;
        fastcgi_param PHP_ADMIN_VALUE "sendmail_path = /usr/sbin/sendmail -t -i -f webmaster@dekan.pro";
        fastcgi_pass unix:/var/www/php-fpm/2.sock;
        fastcgi_split_path_info ^((?U).+\.ph(?:p\d*|tml))(/?.+)$;
        try_files $uri =404;
        include fastcgi_params;
    }
    
    # Обработка WordPress (должен быть последним)
    location / {
        try_files $uri $uri/ /index.php?$args;
    }
}
