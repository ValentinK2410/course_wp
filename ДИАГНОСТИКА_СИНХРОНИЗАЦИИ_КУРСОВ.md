# Диагностика проблемы: курсы не появляются в Laravel

## Шаг 1: Проверка настроек WordPress

### 1.1. Проверьте настройки Laravel API в WordPress

В админ-панели WordPress:
1. Перейдите в **Настройки → Настройки синхронизации Moodle**
2. Проверьте, что заполнены:
   - **Laravel API URL**: `https://m.dekan.pro`
   - **Laravel API Token**: должен совпадать с токеном в Laravel

### 1.2. Проверьте логи WordPress

Проверьте файл `wp-content/debug.log` (если включен `WP_DEBUG`) или `wp-content/uploads/course-plugin-logs/sync-YYYY-MM-DD.log`.

Ищите сообщения:
- `Moodle Sync: Laravel API не настроен` - значит не заполнены настройки
- `Moodle Sync: Отправка курса в Laravel` - запрос отправляется
- `Moodle Sync: Курс успешно синхронизирован` - успешная синхронизация
- `Moodle Sync: Ошибка синхронизации курса с Laravel` - ошибка при синхронизации

## Шаг 2: Проверка Laravel приложения

### 2.1. Проверьте, выполнена ли миграция

На сервере с Laravel выполните:

```bash
cd /path/to/education-management-system
php artisan migrate:status
```

Убедитесь, что миграция `2024_12_22_000002_add_wordpress_and_moodle_fields_to_courses_table.php` выполнена.

Если нет, выполните:
```bash
php artisan migrate
```

### 2.2. Проверьте настройки токена

В файле `.env` Laravel приложения должно быть:

```env
WORDPRESS_API_TOKEN=your-secret-token-here
```

Этот токен должен **точно совпадать** с токеном в настройках WordPress.

### 2.3. Проверьте конфигурацию

В файле `config/services.php` должно быть:

```php
'wordpress_api' => [
    'token' => env('WORDPRESS_API_TOKEN', ''),
    'url' => env('LARAVEL_API_URL', ''),
],
```

После изменения `.env` выполните:
```bash
php artisan config:clear
php artisan cache:clear
```

### 2.4. Проверьте логи Laravel

Проверьте файл `storage/logs/laravel.log` на наличие ошибок:

```bash
tail -f storage/logs/laravel.log
```

Ищите сообщения:
- `Unauthorized API request` - неверный токен
- `Validation failed` - ошибка валидации данных
- `Exception while syncing course` - ошибка при создании курса
- `Course successfully created from WordPress` - успешное создание

## Шаг 3: Проверка API endpoint

### 3.1. Проверьте, что маршрут зарегистрирован

В файле `routes/web.php` должен быть маршрут:

```php
Route::post('/api/courses/sync-from-wordpress', [CourseSyncController::class, 'syncFromWordPress'])
    ->name('api.courses.sync-from-wordpress');
```

### 3.2. Проверьте исключение из CSRF

В файле `bootstrap/app.php` должно быть:

```php
$middleware->validateCsrfTokens(except: [
    'api/users/sync-from-wordpress',
    'api/courses/sync-from-wordpress',
    'sso/login',
]);
```

### 3.3. Тестовый запрос к API

Выполните тестовый запрос с сервера WordPress:

```bash
curl -X POST https://m.dekan.pro/api/courses/sync-from-wordpress \
  -H "Content-Type: application/json" \
  -H "X-API-Token: your-token-here" \
  -d '{
    "wordpress_course_id": 1,
    "moodle_course_id": 1,
    "name": "Тестовый курс",
    "description": "Описание тестового курса",
    "action": "created"
  }'
```

Ожидаемый ответ при успехе:
```json
{
  "success": true,
  "message": "Course created successfully",
  "course": {
    "id": 1,
    "name": "Тестовый курс",
    "wordpress_course_id": 1,
    "moodle_course_id": 1
  }
}
```

## Шаг 4: Проверка модели Course

### 4.1. Проверьте, что поля добавлены в $fillable

В файле `app/Models/Course.php` должны быть поля:

```php
protected $fillable = [
    // ... другие поля
    'wordpress_course_id',
    'moodle_course_id',
    'short_description',
    'category_id',
    'category_name',
    'start_date',
    'end_date',
    'capacity',
    'enrolled',
    'meta',
];
```

### 4.2. Проверьте casts

```php
protected $casts = [
    // ... другие casts
    'start_date' => 'date',
    'end_date' => 'date',
    'meta' => 'array',
];
```

## Шаг 5: Ручная синхронизация существующих курсов

Если курсы уже есть в WordPress, но не синхронизированы с Laravel, можно создать скрипт для ручной синхронизации.

Создайте файл `sync-existing-courses.php` в корне WordPress:

```php
<?php
/**
 * Скрипт для синхронизации существующих курсов из WordPress в Laravel
 * 
 * Запуск: php sync-existing-courses.php
 */

require_once('wp-load.php');

// Получаем все курсы из WordPress
$courses = get_posts(array(
    'post_type' => 'course',
    'posts_per_page' => -1,
    'post_status' => 'any'
));

echo "Найдено курсов: " . count($courses) . "\n";

$sync_instance = Course_Moodle_Sync::get_instance();

foreach ($courses as $course) {
    $moodle_course_id = get_post_meta($course->ID, 'moodle_course_id', true);
    
    if ($moodle_course_id) {
        // Получаем данные курса из Moodle (если нужно)
        // Или используем данные из WordPress
        
        $moodle_course = array(
            'id' => $moodle_course_id,
            'fullname' => $course->post_title,
            'summary' => $course->post_content,
            'shortname' => $course->post_excerpt,
            'categoryid' => get_post_meta($course->ID, 'moodle_category_id', true),
        );
        
        // Вызываем метод синхронизации
        $reflection = new ReflectionClass($sync_instance);
        $method = $reflection->getMethod('sync_course_to_laravel');
        $method->setAccessible(true);
        $method->invoke($sync_instance, $course->ID, $moodle_course, 'created');
        
        echo "Синхронизирован курс: " . $course->post_title . " (ID: " . $course->ID . ")\n";
    } else {
        echo "Пропущен курс (нет moodle_course_id): " . $course->post_title . "\n";
    }
}

echo "Синхронизация завершена!\n";
```

## Частые проблемы и решения

### Проблема 1: "Laravel API не настроен"

**Решение:**
- Заполните настройки Laravel API в WordPress админ-панели
- Убедитесь, что URL и токен указаны правильно

### Проблема 2: "401 Unauthorized"

**Решение:**
- Проверьте, что токены в WordPress и Laravel совпадают
- Выполните `php artisan config:clear` в Laravel после изменения `.env`
- Проверьте заголовок `X-API-Token` в запросе

### Проблема 3: "422 Validation failed"

**Решение:**
- Проверьте логи Laravel для деталей ошибки
- Убедитесь, что все обязательные поля передаются из WordPress
- Проверьте формат данных (например, даты должны быть в формате Y-m-d)

### Проблема 4: "500 Internal Server Error"

**Решение:**
- Проверьте логи Laravel для деталей ошибки
- Убедитесь, что миграция выполнена
- Проверьте, что все поля добавлены в `$fillable` модели Course
- Проверьте, что таблица `courses` существует и имеет нужные колонки

### Проблема 5: Курсы создаются, но поля пустые

**Решение:**
- Проверьте, что поля добавлены в `$fillable` модели Course
- Проверьте, что данные передаются из WordPress (проверьте логи)
- Убедитесь, что миграция выполнена успешно

## Проверка через базу данных

Проверьте, что курсы действительно создаются в Laravel:

```sql
SELECT id, name, wordpress_course_id, moodle_course_id, created_at 
FROM courses 
WHERE wordpress_course_id IS NOT NULL 
ORDER BY created_at DESC;
```

Если курсы есть, но не отображаются в админ-панели, проверьте:
- Фильтры в админ-панели
- Права доступа
- Статус курсов (`is_active`)

