# Решение ошибки "Плагин аутентификации SSO не найден" в Moodle

## Проблема

При попытке доступа к админ-панели Moodle (например, `/admin/user.php`) появляется ошибка:
**"Плагин аутентификации SSO не найден"**

## Причина

Ошибка возникает потому, что:
1. Файл `login.php` был размещен в директории `auth/sso/`, что заставляет Moodle думать, что это плагин аутентификации
2. Moodle пытается загрузить плагин SSO, но он не установлен как полноценный плагин
3. Это вызывает конфликт при доступе к админ-панели

## Решение

Используйте **внешний SSO скрипт**, который не требует установки плагина аутентификации.

### Шаг 1: Удалите старый файл

Удалите файл из директории `auth/sso/`:
```bash
rm /path/to/moodle/auth/sso/login.php
```

Если директория `auth/sso/` пуста, её тоже можно удалить:
```bash
rmdir /path/to/moodle/auth/sso/
```

### Шаг 2: Установите новый внешний SSO скрипт

Скопируйте файл `moodle-sso-external.php` в **корень Moodle**:
```bash
cp moodle-sso-external.php /path/to/moodle/sso-login.php
```

**ВАЖНО**: Файл должен быть в корне Moodle, а НЕ в `auth/sso/`!

### Шаг 3: Установите права доступа

```bash
chmod 644 /path/to/moodle/sso-login.php
```

### Шаг 4: Проверьте настройки аутентификации в Moodle

1. Войдите в админ-панель Moodle как администратор
2. Перейдите в **Администрирование сайта** → **Плагины** → **Аутентификация** → **Управление аутентификацией**
3. Убедитесь, что SSO **НЕ** выбран как метод аутентификации
4. Если SSO там есть и включен - отключите его
5. Используйте стандартные методы аутентификации (например, "Ручная регистрация")

### Шаг 5: Обновите URL в WordPress (уже сделано)

Плагин WordPress уже обновлен для использования нового пути `/sso-login.php` вместо `/auth/sso/login.php`.

## Как это работает

1. **Внешний скрипт** `sso-login.php` находится в корне Moodle
2. Он **не требует** установки плагина аутентификации
3. Работает **независимо** от настроек аутентификации Moodle
4. Используется только при прямом переходе по URL с токеном

## Использование

После установки SSO будет работать через URL:
```
https://class.dekan.pro/sso-login.php?token=YOUR_TOKEN
```

Пользователи будут переходить по этой ссылке автоматически при использовании функции `goToMoodle()` в WordPress.

## Проверка работы

1. **Проверьте доступ к админ-панели Moodle**:
   - Откройте `https://class.dekan.pro/admin/user.php`
   - Ошибка "Плагин аутентификации SSO не найден" должна исчезнуть

2. **Проверьте SSO вход**:
   - Войдите в WordPress
   - Используйте функцию `goToMoodle()` или перейдите по SSO ссылке
   - Должен произойти автоматический вход в Moodle

## Альтернативное решение (если проблема осталась)

Если ошибка все еще появляется, возможно, в настройках Moodle остались ссылки на SSO плагин:

1. **Проверьте конфигурацию базы данных Moodle**:
   ```sql
   SELECT * FROM mdl_config WHERE name LIKE '%auth%';
   ```
   
2. **Проверьте файл конфигурации** `config.php`:
   ```php
   // Убедитесь, что там нет настроек для auth_sso
   ```

3. **Очистите кеш Moodle**:
   - В админ-панели: **Администрирование сайта** → **Разработка** → **Очистить кеш**

## Безопасность

⚠️ **ВАЖНО**: 
- Файл `sso-login.php` должен быть доступен только для чтения веб-сервером
- Не размещайте его в публичных директориях без защиты
- Убедитесь, что настроены правильные права доступа

## Отладка

Если SSO не работает:

1. **Проверьте логи Moodle**:
   - Обычно в `/path/to/moodle/data/error.log`
   - Или в настройках PHP `error_log`

2. **Проверьте логи WordPress**:
   - `wp-content/debug.log`
   - Проверьте, что запросы от Moodle доходят до WordPress

3. **Проверьте URL**:
   - Убедитесь, что файл находится именно в корне Moodle
   - Проверьте, что `require_once(__DIR__ . '/config.php')` правильно загружает конфигурацию

4. **Проверьте права доступа**:
   ```bash
   ls -la /path/to/moodle/sso-login.php
   # Должно быть: -rw-r--r--
   ```

## Резюме

✅ **Правильное решение**: Использовать внешний скрипт `sso-login.php` в корне Moodle  
❌ **Неправильно**: Размещать файл в `auth/sso/login.php` без установки плагина

После выполнения этих шагов ошибка должна исчезнуть, и SSO будет работать корректно.

