# Инструкция по настройке токена Moodle для создания пользователей

## Проблема

В логах видна ошибка:
```
Moodle API Exception: Access control exception
```

Это означает, что токен в Moodle не имеет прав на создание пользователей через функцию `core_user_create_users`.

## Решение: Настройка прав токена в Moodle

### Шаг 1: Войдите в Moodle как администратор

Откройте `https://class.dekan.pro` и войдите с правами администратора.

### Шаг 2: Перейдите в настройки веб-сервисов

1. Перейдите в **Site administration** (Администрирование сайта)
2. Найдите раздел **Plugins** (Плагины)
3. Выберите **Web services** (Веб-сервисы)
4. Нажмите **Overview** (Обзор)

### Шаг 3: Включите веб-сервисы (если еще не включены)

1. Убедитесь, что **Enable web services** (Включить веб-сервисы) установлен в **Yes**
2. Убедитесь, что **Enable REST protocol** (Включить протокол REST) установлен в **Yes**
3. Сохраните изменения

### Шаг 4: Создайте или отредактируйте веб-сервис

1. Перейдите в **Plugins** → **Web services** → **External services** (Внешние сервисы)
2. Найдите существующий сервис или создайте новый
3. Убедитесь, что сервис **Enabled** (Включен)

### Шаг 5: Добавьте функции в веб-сервис

1. В списке веб-сервисов нажмите на название вашего сервиса
2. Перейдите на вкладку **Functions** (Функции)
3. Нажмите **Add functions** (Добавить функции)
4. Найдите и добавьте следующие функции:
   - `core_user_create_users` - **ОБЯЗАТЕЛЬНО** для создания пользователей
   - `core_user_get_users_by_field` - для поиска пользователей
   - `core_user_update_users` - для обновления пользователей
   - `core_user_get_users` - для получения списка пользователей
   - `core_course_get_courses` - для получения курсов
   - `core_course_get_categories` - для получения категорий
   - `core_enrol_get_enrolled_users` - для получения студентов курсов

### Шаг 6: Назначьте пользователя веб-сервису

1. Перейдите в **Plugins** → **Web services** → **External services**
2. Нажмите на название вашего сервиса
3. Перейдите на вкладку **Authorised users** (Авторизованные пользователи)
4. Нажмите **Add** (Добавить)
5. Выберите пользователя, для которого создан токен
6. Сохраните

### Шаг 7: Создайте или обновите токен

1. Перейдите в **Plugins** → **Web services** → **Manage tokens** (Управление токенами)
2. Найдите существующий токен или создайте новый:
   - **User** (Пользователь): выберите пользователя
   - **Service** (Сервис): выберите ваш веб-сервис
   - **IP restriction** (Ограничение IP): оставьте пустым или укажите IP вашего сервера
3. Нажмите **Create token** (Создать токен)
4. Скопируйте созданный токен

### Шаг 8: Обновите токен в WordPress

1. Войдите в WordPress как администратор
2. Перейдите в **Настройки** → **Moodle Sync**
3. Вставьте новый токен в поле **Moodle Token**
4. Убедитесь, что **Moodle URL** правильный: `https://class.dekan.pro` (без слеша в конце)
5. Включите чекбокс **Синхронизировать пользователей**
6. Нажмите **Сохранить изменения**

### Шаг 9: Проверьте права пользователя в Moodle

Убедитесь, что пользователь, для которого создан токен, имеет права на создание пользователей:

1. Перейдите в **Site administration** → **Users** → **Permissions** → **Define roles**
2. Найдите роль пользователя (обычно "Manager" или "Administrator")
3. Убедитесь, что разрешение **moodle/user:create** установлено в **Allow** (Разрешить)

## Альтернативный способ: Использование роли администратора

Если у вас есть доступ к администратору Moodle:

1. Создайте токен для пользователя с правами администратора
2. Используйте этот токен в WordPress

## Проверка работы

После настройки:

1. Зарегистрируйте тестового пользователя в WordPress
2. Проверьте логи в `wp-content/debug.log`
3. Должно быть сообщение: `Moodle User Sync: УСПЕХ! Пользователь успешно создан в Moodle`
4. Проверьте в Moodle, что пользователь создан

## Важные замечания

- Токен должен иметь доступ к функции `core_user_create_users`
- Пользователь, для которого создан токен, должен иметь права на создание пользователей
- Веб-сервис должен быть включен
- REST протокол должен быть включен


















