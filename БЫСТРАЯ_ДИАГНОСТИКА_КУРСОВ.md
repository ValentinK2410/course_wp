# Быстрая диагностика: курсы не переносятся в Laravel

## Шаг 1: Проверьте логи WordPress

После синхронизации курсов проверьте файл:
```
wp-content/course-registration-debug.log
```

Ищите записи с `========== НАЧАЛО СИНХРОНИЗАЦИИ КУРСА С LARAVEL ==========`

### Что проверить в логах:

1. **"Laravel API не настроен"**
   - Решение: Заполните настройки в WordPress → Настройки → Настройки синхронизации Moodle
   - Укажите: Laravel API URL и Laravel API Token

2. **"ОШИБКА ЗАПРОСА"**
   - Проблема с сетью или URL
   - Проверьте, что URL `https://m.dekan.pro` доступен
   - Проверьте, что маршрут `/api/courses/sync-from-wordpress` существует

3. **"ОШИБКА ОТВЕТА: код ответа: 401"**
   - Неверный токен API
   - Решение: Убедитесь, что токены в WordPress и Laravel `.env` совпадают

4. **"ОШИБКА ОТВЕТА: код ответа: 422"**
   - Ошибка валидации данных
   - Проверьте логи Laravel для деталей

5. **"ОШИБКА ОТВЕТА: код ответа: 500"**
   - Внутренняя ошибка Laravel
   - Проверьте логи Laravel: `storage/logs/laravel.log`
   - Возможно, не выполнена миграция

## Шаг 2: Проверьте настройки WordPress

1. Перейдите в **Настройки → Настройки синхронизации Moodle**
2. Проверьте поля:
   - **Laravel API URL**: должно быть `https://m.dekan.pro`
   - **Laravel API Token**: должен совпадать с токеном в Laravel

## Шаг 3: Проверьте Laravel

### 3.1. Выполните миграцию

```bash
cd /path/to/education-management-system
php artisan migrate
```

### 3.2. Проверьте токен в .env

```env
WORDPRESS_API_TOKEN=your-secret-token-here
```

### 3.3. Очистите кэш

```bash
php artisan config:clear
php artisan cache:clear
php artisan route:clear
```

### 3.4. Проверьте логи Laravel

```bash
tail -f storage/logs/laravel.log
```

Ищите сообщения:
- `Unauthorized API request` - неверный токен
- `Validation failed` - ошибка валидации
- `Exception while syncing course` - ошибка при создании курса
- `Course successfully created` - успешное создание

## Шаг 4: Используйте тестовый скрипт

1. Загрузите `course-plugin/test-course-sync.php` на сервер WordPress
2. Откройте в браузере: `https://site.dekan.pro/test-course-sync.php`
3. Скрипт покажет все проблемы и выполнит тестовый запрос

## Шаг 5: Ручная проверка API

Выполните тестовый запрос с сервера WordPress:

```bash
curl -X POST https://m.dekan.pro/api/courses/sync-from-wordpress \
  -H "Content-Type: application/json" \
  -H "X-API-Token: ваш-токен-здесь" \
  -d '{
    "wordpress_course_id": 1,
    "moodle_course_id": 1,
    "name": "Тестовый курс",
    "description": "Описание",
    "action": "created"
  }'
```

Ожидаемый ответ при успехе:
```json
{
  "success": true,
  "message": "Course created successfully",
  "course": {
    "id": 1,
    "name": "Тестовый курс"
  }
}
```

## Частые проблемы и решения

| Проблема | Решение |
|----------|---------|
| Токены не совпадают | Проверьте `.env` в Laravel и настройки WordPress |
| Миграция не выполнена | Выполните `php artisan migrate` |
| Маршрут не найден | Проверьте `routes/web.php` и выполните `php artisan route:clear` |
| CSRF ошибка | Проверьте `bootstrap/app.php` - маршрут должен быть исключен |
| Поля не в fillable | Проверьте модель `Course` - все поля должны быть в `$fillable` |

## Что делать после исправления

1. Выполните синхронизацию курсов из Moodle в WordPress
2. Проверьте логи: `wp-content/course-registration-debug.log`
3. Проверьте, что курсы появились в Laravel

